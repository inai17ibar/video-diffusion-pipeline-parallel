# パイプライン並列の性能分析

## 現状の実験結果の問題点

現在の実験では、**単一サンプルのレイテンシ**を測定しており、GPU数が増えるほど性能が悪化している。

### DummyUNet（シミュレータ）結果
| GPU数 | 合計時間 | 変化率 |
|-------|----------|--------|
| 1 | 3.93秒 | ベースライン |
| 2 | 4.55秒 | +16% 悪化 |
| 4 | 5.68秒 | +45% 悪化 |
| 7 | 7.23秒 | +84% 悪化 |

### SVD本番モード結果
| フレーム数 | GPU数 | 合計時間 |
|-----------|-------|----------|
| 2 | 1 | 4.8秒 |
| 14 | 7 | 8.4秒 |

---

## なぜ単一サンプルで性能が悪化するのか

### パイプライン並列の特性

パイプライン並列は**スループット最適化**の手法であり、**レイテンシ最適化**ではない。

```
単一サンプルの実行フロー:

時間 →
GPU0: [処理]→送信→待機.....................
GPU1:        受信→[処理]→送信→待機........
GPU2:               受信→[処理]→送信→待機..
...
GPU6:                              受信→[処理]→完了

合計時間 = Σ(各GPUの処理時間) + Σ(通信時間)
```

**単一サンプルでは:**
- 各GPUが順次処理するため、並列性がない
- GPU間通信のオーバーヘッドが加算される
- GPU数が増えるほど通信回数が増加し、悪化する

---

## パイプライン並列のメリットが出るケース

### 複数サンプル連続生成時

```
複数サンプルの実行フロー（定常状態）:

時間 →
GPU0: [S1][S2][S3][S4][S5][S6][S7]...
GPU1:    [S1][S2][S3][S4][S5][S6]...
GPU2:       [S1][S2][S3][S4][S5]...
GPU3:          [S1][S2][S3][S4]...
GPU4:             [S1][S2][S3]...
GPU5:                [S1][S2]...
GPU6:                   [S1]...

定常状態: 1GPUあたりのステップ時間ごとに1サンプルが完了
```

### 理論的な性能比較

| 構成 | 1サンプルのレイテンシ | 10サンプル合計 | スループット |
|------|----------------------|----------------|--------------|
| 1 GPU (28ステップ) | 28 × 150ms = 4.2秒 | 42秒 | 0.24 サンプル/秒 |
| 7 GPU (4ステップ/GPU) | ~8秒 | ~14秒 | **0.71 サンプル/秒** |

**7GPUでの10サンプル生成:**
- パイプライン充填: 7 × (4 × 150ms) ≈ 4.2秒
- 定常状態: 9サンプル × (4 × 150ms) ≈ 5.4秒
- 合計: 約10秒
- **スループット向上: 約3倍**

---

## パイプライン並列が有効なユースケース

### 適している
| ユースケース | 理由 |
|-------------|------|
| バッチ生成 | 複数サンプルで定常状態に到達 |
| リトライ生成 | 1枚の画像から複数候補を生成 |
| A/Bテスト | 異なるパラメータで複数生成 |
| メモリ制約 | 14フレームビデオは7GPU必須 |

### 適していない
| ユースケース | 理由 |
|-------------|------|
| 単発リクエスト | レイテンシが悪化 |
| リアルタイム応答 | 初回レイテンシが重要 |
| 少量生成 | パイプライン充填のオーバーヘッド |

---

## 次の実験で検証すべきこと

### 1. マルチサンプルスループット測定

```bash
# GPU数を変えて10サンプル生成のスループットを比較
for NGPUS in 1 2 4 7; do
    torchrun --nproc_per_node=$NGPUS -m src.modes.production \
        --total-steps 28 \
        --latent-shape 1 4 14 32 32 \
        --num-samples 10 \
        --enable-memory-opt
done
```

### 2. 測定すべき指標

| 指標 | 説明 |
|------|------|
| 最初のサンプル完了時間 | パイプライン充填時間 |
| 合計完了時間 | 全サンプル生成の総時間 |
| 定常状態スループット | (合計時間 - 初回時間) / (サンプル数 - 1) |
| GPU使用率 | 各GPUの稼働率 |

### 3. 期待される結果

| GPU数 | 10サンプル合計（予測） | スループット向上 |
|-------|----------------------|-----------------|
| 1 | 42秒 | 1.0x |
| 2 | 25秒 | 1.7x |
| 4 | 15秒 | 2.8x |
| 7 | 10秒 | 4.2x |

---

## 結論

1. **現在の実験結果は正しい** - 単一サンプルではパイプライン並列は逆効果
2. **メリットは複数サンプル生成時に発現** - 定常状態でスループット向上
3. **追加実験が必要** - `--num-samples 10` 以上でスループットを測定
4. **メモリ制約も重要** - 14フレームビデオは1GPUでは生成不可
